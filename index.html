<!doctype html>
<html lang="ko">
<head>
<link rel="manifest" href="/manifest.json">
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover, shrink-to-fit=no" />
  <title>Chat</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      /* Í∏∞Î≥∏(ÏÉÅÎåÄ/ÎÇ¥ ÎßêÌíçÏÑ†) */
      --me:#374151;
      --meText:#ffffff;

      --other:#ffffff;
      --otherText:#111827;

      --accent:#22c55e;
      --danger:#ef4444;

      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
      --kb: 0px;
      --composerH: 64px;

      --typingH: 34px;

      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --shadow2: 0 14px 40px rgba(0,0,0,0.12);
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      overflow:hidden;
    }

    button, .clickable{
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      cursor: pointer;
      transition: transform .08s ease, box-shadow .18s ease, filter .18s ease, background .18s ease, border-color .18s ease;
    }
    button:active, .clickable:active{ transform: translateY(1px) scale(0.99); }
    button:focus-visible{
      outline: 3px solid rgba(34,197,94,0.35);
      outline-offset: 2px;
    }

    .app{
      height:100vh;
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding-top: var(--safeT);
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      padding: 12px 14px 10px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(12px);
    }

    .headTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-size:16px;
      font-weight:800;
      margin:0;
      line-height:1.2;
    }
    .sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
    }

    .menuWrap{
      position:relative;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .menuBtn{
      width:40px;
      height:40px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      line-height:1;
      user-select:none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .menuBtn:hover{ filter: brightness(0.98); }
    .menu{
      position:absolute;
      right:0;
      top:46px;
      min-width: 280px;
      background:#fff;
      border:1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:none;
    }
    .menu.open{ display:block; }
    .menu button{
      width:100%;
      padding: 12px 12px;
      border:0;
      background:#fff;
      text-align:left;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .menu button:hover{ background:#f8fafc; }
    .menu button:active{ background:#f3f4f6; }
    .menu .hint{
      font-size:12px;
      color:var(--muted);
      padding:10px 12px;
      border-top:1px solid var(--line);
      line-height:1.35;
      white-space:pre-wrap;
    }

    .home{
      flex:1;
      overflow:auto;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
    }
    .homeCard{
      width:100%;
      max-width: 720px;
      margin: 0 auto;
      background:#fff;
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .homeTitle{
      font-weight:900;
      font-size:18px;
      margin:0 0 10px 0;
    }
    .sectionTitle{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      margin: 14px 0 8px 0;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin: 10px 0;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }
    .field input{
      height:46px;
      border-radius: 14px;
      border:1px solid var(--line);
      padding: 0 12px;
      font-size:16px;
      outline:none;
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    .field input:focus{
      border-color: rgba(34,197,94,0.6);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.12);
    }
    .rowBtns{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .primaryBtn{
      flex:1;
      height:46px;
      border-radius: 14px;
      border:0;
      background:#111827;
      color:#fff;
      font-size:15px;
      font-weight:900;
      box-shadow: 0 10px 18px rgba(17,24,39,0.14);
    }
    .primaryBtn:hover{ filter: brightness(1.03); }
    .ghostBtn{
      flex:1;
      height:46px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      font-size:15px;
      font-weight:800;
    }
    .ghostBtn:hover{ background:#f8fafc; }

    .roomList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .roomItem{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .roomItem:hover{ background:#f8fafc; }
    .roomLeft{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .roomName{
      font-weight:900;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .roomMeta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .roomRight{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }
    .chip{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size:12px;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .log{
      flex:1;
      overflow:auto;
      padding: 12px 12px calc(var(--composerH) + var(--typingH) + var(--kb) + var(--safeB) + 12px) 12px;
      -webkit-overflow-scrolling: touch;
    }

    .msg{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin: 10px 0;
      width:100%;
    }
    .row{
      display:flex;
      gap:8px;
      width:100%;
    }
    .row.me{ justify-content:flex-end; }
    .row.other{ justify-content:flex-start; }

    .bubble{
      max-width: 82%;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: var(--other);
      color: var(--otherText);
      white-space: pre-wrap;
      word-break: break-word;
      font-size:16px;
      line-height:1.35;
    }
    .row.me .bubble{
    background: var(--me);
    color: var(--meText);
    border-color: transparent;
    border-bottom-right-radius: 6px;
    box-shadow: none;
    background-image: none;
    }
    .row.other .bubble{
      border-bottom-left-radius: 6px;
    }

    .meta{
      font-size:11px;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .meta.me{ justify-content:flex-end; }
    .badgePending{ opacity:0.78; }
    .badgeFail{ color: var(--danger); font-weight:900; cursor:pointer; }

    /* ÏùΩÏùå ÌëúÏãú */
    .readBadge{
      font-weight:900;
      opacity:0.85;
    }

    /* ÏûÖÎ†•Ï∞Ω Î∞îÎ°ú ÏúÑ typing bar */
    .typingBar{
      position:fixed;
      left:0;
      right:0;
      bottom: calc(var(--composerH) + var(--kb) + var(--safeB));
      height: var(--typingH);
      display:none;
      align-items:center;
      padding: 0 12px;
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px);
      border-top:1px solid var(--line);
      z-index:19;
    }

    .composer{
      position:fixed;
      left:0;
      right:0;
      bottom: calc(var(--kb) + var(--safeB));
      height: var(--composerH);
      padding: 10px 12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px);
      display:flex;
      gap:10px;
      align-items:center;
      z-index:20;
    }

    .emojiBtn{
      width:48px;
      height:48px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: #fff;
      font-size:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .emojiBtn:hover{ filter: brightness(0.98); }

    .inputWrap{
      flex:1;
      height:48px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      display:flex;
      align-items:center;
      padding: 0 12px;
    }
    input[type="text"]{
      width:100%;
      border:0;
      outline:none;
      font-size:16px;
      background:transparent;
    }

    .sendBtn{
      width:64px;
      height:48px;
      border-radius: 14px;
      border:0;
      background:#111827;
      color:#fff;
      font-size:15px;
      font-weight:900;
      box-shadow: 0 10px 18px rgba(17,24,39,0.14);
    }
    .sendBtn:disabled{ opacity:0.45; box-shadow:none; }

    .emojiPanel{
      position:fixed;
      left:12px;
      right:12px;
      bottom: calc(var(--composerH) + var(--kb) + var(--safeB) + 10px);
      background:#fff;
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      box-shadow: var(--shadow);
      display:none;
      z-index:30;
    }
    .emojiPanel.open{ display:block; }
    .emojiGrid{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:8px;
    }
    .emoji{
      height:38px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      user-select:none;
      border:1px solid transparent;
    }
    .emoji:hover{ background:#f8fafc; }
    .emoji:active{ border-color: var(--line); }

    @media (max-width: 420px){
      .bubble{ max-width: 88%; }
      .emojiGrid{ grid-template-columns: repeat(7, 1fr); }
    }
  </style>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "90c2ab9b-c948-4b4d-8f1e-56326f9b7aea"
    });
window.__OS = OneSignal;
try{
  OneSignal.User.PushSubscription.addEventListener("change", function(){
    window.__schedulePushSync && window.__schedulePushSync();
  });
  window.__schedulePushSync && window.__schedulePushSync();
}catch(e){}
  });

</script>
</head>
<body>
  <div class="app" id="app">
    <header id="header" style="display:none;">
      <div class="headTop">
        <div>
          <div class="title" id="roomTitle">Ï±ÑÌåÖÎ∞©</div>
          <div class="sub" id="roomSub"></div>
        </div>

        <div class="menuWrap">
          <div class="menuBtn clickable" id="menuBtn">‚Ä¶</div>
          <div class="menu" id="menu">
            <button id="mEnableNoti"><span>ÏïåÎ¶º ÏºúÍ∏∞</span><span id="mEnableNotiState">‚Ä∫</span></button>
            <button id="mSound"><span>ÏÜåÎ¶¨(ÏÇê) ÏºúÍ∏∞</span><span id="mSoundState">‚Ä∫</span></button>

            <!-- Ï∂îÍ∞Ä: ÎÇ¥ ÎßêÌíçÏÑ† ÏÉâÏÉÅ ÌÜ†Í∏Ä -->
            <button id="mMyBubbleWhite"><span>ÎÇ¥ ÎßêÌíçÏÑ† Ìù∞ÏÉâ(ÏÉÅÎåÄÏôÄ ÎèôÏùº)</span><span id="mMyBubbleWhiteState">‚Ä∫</span></button>

            <button id="mNick"><span>ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω</span><span>‚Ä∫</span></button>
            <button id="mRoomName"><span>Î∞© Ïù¥Î¶Ñ Î≥ÄÍ≤Ω(Î∞©Ïû•)</span><span>‚Ä∫</span></button>
            <button id="mLeave"><span>ÎÇòÍ∞ÄÍ∏∞</span><span>‚Ä∫</span></button>
            <div class="hint" id="menuHint"></div>
          </div>
        </div>
      </div>
    </header>

    <div class="home" id="home">
      <div class="homeCard">
        <div class="homeTitle">ÎåÄÍ∏∞Ïã§</div>

        <div class="field">
          <label>ÎÇ¥ ÎãâÎÑ§ÏûÑ</label>
          <input id="homeNick" type="text" placeholder="Ïòà: ÏÜ°ÎåÄÌò∏" />
        </div>

        <div class="sectionTitle">Î∞© ÎßåÎì§Í∏∞</div>
        <div class="field">
          <label>Î∞© Ïù¥Î¶Ñ</label>
          <input id="homeRoomName" type="text" placeholder="Ïòà: ÌÖåÏä§Ìä∏Î∞©" />
        </div>

        <div class="rowBtns">
          <button class="primaryBtn" id="btnCreate">Î∞© ÎßåÎì§Í∏∞</button>
          <button class="ghostBtn" id="btnRefresh">ÏÉàÎ°úÍ≥†Ïπ®</button>
        </div>

        <div class="sectionTitle">Ï±ÑÌåÖÎ∞© Î™©Î°ù</div>
        <div class="roomList" id="roomList"></div>

        <div class="rowBtns">
          <button class="ghostBtn" id="btnJoin">Ï∞∏Ïó¨ÌïòÍ∏∞</button>
        </div>

        <div class="sectionTitle">ÏïàÎÇ¥</div>
        <div class="roomMeta">
          <span class="pill">ÎàÑÍµ¨ÎÇò Ìé∏ÌïòÍ≤å ÎåÄÌôîÌï† Ïàò ÏûàÎäî Ï±ÑÌåÖÎ∞©ÏûÖÎãàÎã§.</span>
        </div>
      </div>
    </div>

    <div class="typingBar" id="typingBar" aria-hidden="true"></div>

    <div class="log" id="log" style="display:none;"></div>

    <div class="emojiPanel" id="emojiPanel" aria-hidden="true">
      <div class="emojiGrid" id="emojiGrid"></div>
    </div>

    <div class="composer" id="composer" style="display:none;">
      <div class="emojiBtn clickable" id="emojiBtn">üòä</div>
      <div class="inputWrap">
        <input id="input" type="text" autocomplete="off" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
      </div>
      <button class="sendBtn" id="send" disabled>Ï†ÑÏÜ°</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <script>
    const SERVICE_URL = location.href;
    const INIT_ROOM_ID = new URLSearchParams(location.search).get('roomId') || '';

    const PUSH_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwlHLWiKMMbzlpXQCUdz-9fP5iX_1iVhbnxG-JLoCAgQc8FZCnCbKOoZl9Xj7NwtMjK/exec";
    const PUSH_SECRET = "ryo1234";

    const firebaseConfig = {
      apiKey: "AIzaSyC6iyCkpqtaWgFXlJZiogn2SgfIz9j1I4M",
      authDomain: "messenger-222df.firebaseapp.com",
      databaseURL: "https://messenger-222df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "messenger-222df",
      storageBucket: "messenger-222df.firebasestorage.app",
      messagingSenderId: "694962613962",
      appId: "1:694962613962:web:764e45b00345a8a27f4e33",
      measurementId: "G-18XS6BY9GK"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const SV = firebase.database.ServerValue;

    const NAV_URL = location.origin + location.pathname;

    const LS_NICK   = 'chat_nick_fb_v1';
    const LS_NOTI   = 'chat_notify_enabled_v1';
    const LS_SOUND  = 'chat_beep_enabled_v1';

    // Ï∂îÍ∞Ä: ÎÇ¥ ÎßêÌíçÏÑ† Ìù∞ÏÉâ ÌÜ†Í∏Ä Ï†ÄÏû•ÌÇ§
    const LS_MY_BUBBLE_WHITE = 'chat_my_bubble_white_v1';

    // Í∏∞Î≥∏(ÏõêÎûò) ÎÇ¥ ÎßêÌíçÏÑ† ÏÉâÏÉÅ Î∞±ÏóÖ(Î≥µÏõêÏö©)
    const DEFAULT_ME_BG   = '#374151';
    const DEFAULT_ME_TEXT = '#ffffff';

    // ÏÉÅÎåÄ(Í∏∞Î≥∏) ÎßêÌíçÏÑ† ÏÉâÏÉÅ
    const DEFAULT_OTHER_BG   = '#ffffff';
    const DEFAULT_OTHER_TEXT = '#111827';

    function pushToSubscriptions(subscriptionIds, title, body, roomId){
  try{
    if (!PUSH_WEBHOOK_URL) return;
    if (!Array.isArray(subscriptionIds) || subscriptionIds.length === 0) return;

    const url = NAV_URL + '?roomId=' + encodeURIComponent(roomId);

    const payload = {
      secret: PUSH_SECRET,
      include_subscription_ids: subscriptionIds.slice(0, 20000),
      title: String(title || 'Chat'),
      body: String(body || 'New message'),
      url
    };

    // CORS ÎïåÎ¨∏Ïóê ÏùëÎãµÏùÄ Ïã†Í≤Ω Ïì∞ÏßÄ ÏïäÍ≥† "Î∞úÏÇ¨"Îßå Ìï©ÎãàÎã§.
    fetch(PUSH_WEBHOOK_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    }).catch(()=>{});
  }catch(e){}
}
    
    function uuid(){
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return 'u' + Date.now() + '_' + Math.random().toString(16).slice(2);
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function fmt(ts){
      try{
        return new Intl.DateTimeFormat('ko-KR', { month:'numeric', day:'numeric', hour:'numeric', minute:'2-digit' }).format(new Date(ts));
      }catch(e){
        return new Date(ts).toLocaleString();
      }
    }

    function isInIframe(){
      try{ return window.top !== window.self; }catch(e){ return true; }
    }
    function isIOS(){
      const ua = navigator.userAgent || '';
      const iOS = /iPhone|iPad|iPod/i.test(ua);
      const iPadOS13 = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      return iOS || iPadOS13;
    }
    function isStandalonePWA(){
      return (window.navigator.standalone === true) || (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
    }

    // UI refs
    const header = document.getElementById('header');
    const roomTitle = document.getElementById('roomTitle');
    const roomSub = document.getElementById('roomSub');

    const menuBtn = document.getElementById('menuBtn');
    const menu = document.getElementById('menu');
    const menuHint = document.getElementById('menuHint');

    const mEnableNoti = document.getElementById('mEnableNoti');
    const mEnableNotiState = document.getElementById('mEnableNotiState');
    const mSound = document.getElementById('mSound');
    const mSoundState = document.getElementById('mSoundState');

    // Ï∂îÍ∞Ä: ÎÇ¥ ÎßêÌíçÏÑ† Ìù∞ÏÉâ ÌÜ†Í∏Ä Î©îÎâ¥
    const mMyBubbleWhite = document.getElementById('mMyBubbleWhite');
    const mMyBubbleWhiteState = document.getElementById('mMyBubbleWhiteState');

    const mNick = document.getElementById('mNick');
    const mRoomName = document.getElementById('mRoomName');
    const mLeave = document.getElementById('mLeave');

    const home = document.getElementById('home');
    const homeNick = document.getElementById('homeNick');
    const homeRoomName = document.getElementById('homeRoomName');

    const btnCreate = document.getElementById('btnCreate');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnJoin = document.getElementById('btnJoin');
    const roomList = document.getElementById('roomList');

    const logEl = document.getElementById('log');
    const composer = document.getElementById('composer');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const emojiGrid = document.getElementById('emojiGrid');

    const typingBar = document.getElementById('typingBar');

    const EMOJIS = ['üòÄ','üòÑ','üòä','üòç','üòò','üòé','ü•π','üòÇ','üò≠','üò°','üëç','üëè','üôè','üî•','üéâ','üíØ','‚ù§Ô∏è','‚ú®','‚≠ê','‚úÖ','‚ùå','‚ö°','üçÄ','‚òï','üçú','üéÆ','üìå','üìù'];
    function buildEmoji(){
      emojiGrid.innerHTML = '';
      EMOJIS.forEach(e => {
        const d = document.createElement('div');
        d.className = 'emoji clickable';
        d.textContent = e;
        d.addEventListener('click', () => {
          inputEl.value = (inputEl.value || '') + e;
          onInput();
          inputEl.focus();
          markTypingActivity();
        });
        emojiGrid.appendChild(d);
      });
    }
    buildEmoji();

    function updateKeyboardInset(){
      if (!window.visualViewport) return;
      const vv = window.visualViewport;
      const kb = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));
      document.documentElement.style.setProperty('--kb', kb + 'px');
    }
    if (window.visualViewport){
      window.visualViewport.addEventListener('resize', updateKeyboardInset);
      window.visualViewport.addEventListener('scroll', updateKeyboardInset);
      updateKeyboardInset();
    }

    function closeMenu(){ menu.classList.remove('open'); }
    menuBtn.addEventListener('click', () => menu.classList.toggle('open'));
    document.addEventListener('click', (e) => {
      if (menuBtn.contains(e.target)) return;
      if (menu.contains(e.target)) return;
      closeMenu();
    });

    emojiBtn.addEventListener('click', () => {
      emojiPanel.classList.toggle('open');
      emojiPanel.setAttribute('aria-hidden', emojiPanel.classList.contains('open') ? 'false' : 'true');
    });
    document.addEventListener('click', (e) => {
      if (emojiBtn.contains(e.target)) return;
      if (emojiPanel.contains(e.target)) return;
      emojiPanel.classList.remove('open');
      emojiPanel.setAttribute('aria-hidden', 'true');
    });

    // auth + state
    let myUid = '';
    let myNick = (localStorage.getItem(LS_NICK) || '').trim();

    let roomId = '';
    let roomName = '';
    let ownerUid = '';
    let ownerNick = '';
    let isOwner = false;

    // presence
    let presenceTimer = null;
    let presenceRef = null;

    // typing
    let typingKeepAliveTimer = null;
    let typingWatchRef = null;
    let lastTypeAt = 0;
    let typingOn = false;

    // reads (ÏùΩÏùå)
    let readsWatchRef = null;
    let readsCache = {};
    let readsMarkTimer = null;
    let readsScrollTimer = null;

    // messages
    let msgUnsub = null;
    let afterSeq = 0;
    const seen = new Map(); // messageId -> { seq, metaEl, senderId }
    const pending = new Map();

    // ---- ÏïåÎ¶º/ÏÜåÎ¶¨/ÌÉÄÏù¥ÌãÄ ----
    const TITLE_BASE = 'Chat';
    let unread = 0;
    let titleBlinkTimer = null;

    let notifyEnabled = (localStorage.getItem(LS_NOTI) === '1');
    let soundEnabled  = (localStorage.getItem(LS_SOUND) === '1');

// ===== OneSignal Íµ¨ÎèÖID -> Firebase Ï†ÄÏû• =====
function syncPushSubToFirebase(){
  try{
    if (!window.__OS) return;
    if (!myUid) return;

    const subId = window.__OS.User.PushSubscription.id || '';
    const optedIn = (window.__OS.User.PushSubscription.optedIn === true);

    // ÏïÑÏßÅ Íµ¨ÎèÖÏù¥ ÏóÜÏúºÎ©¥ Ï†ÄÏû•ÌïòÏßÄ ÏïäÏùå
    if (!optedIn || !subId) return;

    const onesignalId = window.__OS.User.onesignalId || null;

    db.ref('pushSubs/' + myUid + '/' + subId).set({
      onesignalId,
      nick: myNick || '',
      updatedAt: SV.TIMESTAMP
    }).catch(()=>{});
  }catch(e){}
}

let __pushSyncTimer = null;
function schedulePushSync(){
  if (__pushSyncTimer) clearTimeout(__pushSyncTimer);
  __pushSyncTimer = setTimeout(syncPushSubToFirebase, 300);
}
window.__schedulePushSync = schedulePushSync;


    // Ï∂îÍ∞Ä: ÎÇ¥ ÎßêÌíçÏÑ† Ìù∞ÏÉâ Î™®Îìú
    let myBubbleWhite = (localStorage.getItem(LS_MY_BUBBLE_WHITE) === '1');

    function applyMyBubbleTheme(){
      if (myBubbleWhite){
        // ÎÇ¥ ÎßêÌíçÏÑ†ÏùÑ ÏÉÅÎåÄÏôÄ ÎèôÏùºÌïòÍ≤å(Ìù∞ÏÉâ) ÎßûÏ∂§
        document.documentElement.style.setProperty('--me', DEFAULT_OTHER_BG);
        document.documentElement.style.setProperty('--meText', DEFAULT_OTHER_TEXT);
      } else {
        // Í∏∞Î≥∏Í∞í(ÏõêÎûò ÏÉÅÌÉú) Î≥µÏõê
        document.documentElement.style.setProperty('--me', DEFAULT_ME_BG);
        document.documentElement.style.setProperty('--meText', DEFAULT_ME_TEXT);
      }
    }
    applyMyBubbleTheme();

    // iOS Ïò§ÎîîÏò§ unlock
    let audioCtx = null;
    let audioReady = false;
    const BEEP_WAV =
      "data:audio/wav;base64," +
      "UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=";
    const beepAudio = new Audio(BEEP_WAV);
    beepAudio.preload = 'auto';
    beepAudio.playsInline = true;

    async function unlockAudioHard(){
      try{
        if (!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state !== 'running'){
          await audioCtx.resume();
        }
        audioReady = true;
      }catch(e){
        audioReady = false;
      }

      try{
        beepAudio.currentTime = 0;
        await beepAudio.play();
        beepAudio.pause();
        beepAudio.currentTime = 0;
      }catch(e){}
    }

    function playBeep(){
      if (!soundEnabled) return;

      if (audioCtx && audioReady){
        try{
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = 'sine';
          o.frequency.value = 880;
          g.gain.value = 0.0001;
          o.connect(g);
          g.connect(audioCtx.destination);

          const now = audioCtx.currentTime;
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.15, now + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
          o.start(now);
          o.stop(now + 0.2);
          return;
        }catch(e){}
      }

      try{
        const a = new Audio(BEEP_WAV);
        a.playsInline = true;
        a.currentTime = 0;
        a.play().catch(()=>{});
      }catch(e){}
    }

    function startTitleBlink(){
      if (titleBlinkTimer) return;
      let flip = false;
      titleBlinkTimer = setInterval(() => {
        flip = !flip;
        if (unread <= 0){
          stopTitleBlink();
          return;
        }
        document.title = flip ? `(${unread}) ÏÉà Î©îÏãúÏßÄ` : TITLE_BASE;
      }, 900);
    }
    function stopTitleBlink(){
      if (titleBlinkTimer){
        clearInterval(titleBlinkTimer);
        titleBlinkTimer = null;
      }
      document.title = TITLE_BASE;
    }
    function bumpUnread(){
      unread = Math.min(999, unread + 1);
      startTitleBlink();
      setHeader();
    }
    function clearUnread(){
      unread = 0;
      stopTitleBlink();
      setHeader();
    }

    function shouldNotifyNow(){
      return (document.hidden || !document.hasFocus() || !isNearBottom());
    }

    function notifyNewMessage(msg){
      try{
        if (!notifyEnabled) return;
        if (!('Notification' in window)) return;
        if (Notification.permission !== 'granted') return;

        const body = `${msg.senderNick || 'ÏÉÅÎåÄ'}: ${String(msg.text || '').slice(0, 140)}`;
        const n = new Notification(roomName || 'Ï±ÑÌåÖ', {
          body,
          tag: (roomId ? ('room_' + roomId) : undefined),
          renotify: true
        });
        n.onclick = () => { try{ window.focus(); }catch(e){} };
      }catch(e){}
    }

    function showOpenNewTabGuide(){
      const url = location.href;
      menuHint.innerHTML =
        (menuHint.textContent ? escapeHtml(menuHint.textContent) + "\n\n" : "") +
        `ÏïåÎ¶º ÏÑ§Ï†ïÏùÑ ÏúÑÌï¥ ÏÉà ÌÉ≠ÏúºÎ°ú Ïó¨ÏÑ∏Ïöî:\n` +
        `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">ÏÉà ÌÉ≠ÏúºÎ°ú Ïó¥Í∏∞</a>`;
    }

    async function enableNotificationsFromUserGesture(){
      if (isIOS() && !isStandalonePWA()){
        alert('iPhone Safari(Î∏åÎùºÏö∞Ï†Ä)ÏóêÏÑúÎäî ÏãúÏä§ÌÖú ÏïåÎ¶ºÏù¥ ÏßÄÏõêÎêòÏßÄ ÏïäÏäµÎãàÎã§.\n(Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä(PWA) ÌòïÌÉúÏóêÏÑúÎäî Í∞ÄÎä•Ìï† Ïàò ÏûàÏäµÎãàÎã§.)');
        return;
      }

      if (!('Notification' in window)){
        alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏãúÏä§ÌÖú ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
        return;
      }

      if (isInIframe()){
        showOpenNewTabGuide();
        alert('ÌòÑÏû¨ ÌéòÏù¥ÏßÄÍ∞Ä ÏûÑÎ≤†Îìú(iframe)Î°ú Ïó¥Î†§ ÏûàÏñ¥ ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠Ïù¥ Ï∞®Îã®Îê† Ïàò ÏûàÏäµÎãàÎã§.\nÎ©îÎâ¥ ÌïòÎã® ÏïàÎÇ¥Ïóê ÏÉùÍ∏¥ "ÏÉà ÌÉ≠ÏúºÎ°ú Ïó¥Í∏∞" ÎßÅÌÅ¨Î°ú Ïó¥Î¶∞ ÌÉ≠ÏóêÏÑú Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
        return;
      }

      try{
        const perm = await Notification.requestPermission();
        if (perm === 'granted'){
          notifyEnabled = true;
          localStorage.setItem(LS_NOTI, '1');
          await unlockAudioHard();
          updateMenuStates();
          alert('ÏïåÎ¶ºÏù¥ ÏºúÏ°åÏäµÎãàÎã§.');
        } else if (perm === 'denied'){
          notifyEnabled = false;
          localStorage.setItem(LS_NOTI, '0');
          updateMenuStates();
          alert('ÏïåÎ¶ºÏù¥ Ï∞®Îã®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.\nÎ∏åÎùºÏö∞Ï†Ä ÏÇ¨Ïù¥Ìä∏ ÏÑ§Ï†ïÏóêÏÑú ÏïåÎ¶ºÏùÑ "ÌóàÏö©"ÏúºÎ°ú Î∞îÍøî Ï£ºÏÑ∏Ïöî.');
        } else {
          notifyEnabled = false;
          localStorage.setItem(LS_NOTI, '0');
          updateMenuStates();
          alert('ÏïåÎ¶º Í∂åÌïúÏù¥ ÌóàÏö©ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }
      }catch(e){
        alert('ÏïåÎ¶º ÏÑ§Ï†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }

    async function toggleSoundFromUserGesture(){
      soundEnabled = !soundEnabled;
      localStorage.setItem(LS_SOUND, soundEnabled ? '1' : '0');

      if (soundEnabled){
        await unlockAudioHard();
        playBeep();
      }

      updateMenuStates();

      if (soundEnabled && isIOS()){
        alert('iPhoneÏóêÏÑú ÏÜåÎ¶¨Í∞Ä Ïïà ÎÇòÎ©¥:\n- Î¨¥Ïùå Î™®Îìú(ÏÇ¨ÏùºÎü∞Ïä§ Ïä§ÏúÑÏπò) Ìï¥Ï†ú\n- ÎØ∏ÎîîÏñ¥ Î≥ºÎ•® Ïò¨Î¶º\n- ÏßëÏ§ë Î™®Îìú/ÏÇ¨ÌååÎ¶¨ ÏùåÏÜåÍ±∞ ÏÉÅÌÉú ÌôïÏù∏\nÏù¥ Ï°∞Í±¥ÏùÄ ÏΩîÎìúÎ°ú Í∞ïÏ†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
      }
    }

    // Ï∂îÍ∞Ä: ÎÇ¥ ÎßêÌíçÏÑ† Ìù∞ÏÉâ ÌÜ†Í∏Ä
    function toggleMyBubbleWhite(){
      myBubbleWhite = !myBubbleWhite;
      localStorage.setItem(LS_MY_BUBBLE_WHITE, myBubbleWhite ? '1' : '0');
      applyMyBubbleTheme();
      updateMenuStates();
    }

    function updateMenuStates(){
      const supported = ('Notification' in window);
      const iosNoNoti = isIOS() && !isStandalonePWA();

      let notiText = 'Í∫ºÏßê';
      if (iosNoNoti) {
        notiText = 'ÎØ∏ÏßÄÏõê';
      } else if (!supported) {
        notiText = 'ÎØ∏ÏßÄÏõê';
      } else {
        const perm = Notification.permission;
        if (perm === 'denied') notiText = 'Ï∞®Îã®Îê®';
        else if (perm === 'granted' && notifyEnabled) notiText = 'ÏºúÏßê';
        else if (perm === 'granted' && !notifyEnabled) notiText = 'Í∫ºÏßê';
        else if (perm === 'default') notiText = 'ÏöîÏ≤≠ ÌïÑÏöî';
      }
      mEnableNotiState.textContent = notiText;
      mSoundState.textContent = soundEnabled ? 'ÏºúÏßê' : 'Í∫ºÏßê';

      // Ï∂îÍ∞Ä: ÎÇ¥ ÎßêÌíçÏÑ† Ìù∞ÏÉâ ÏÉÅÌÉú ÌëúÏãú
      mMyBubbleWhiteState.textContent = myBubbleWhite ? 'ÏºúÏßê' : 'Í∫ºÏßê';

      const hints = [];
      hints.push(`ÌòÑÏû¨ ÎèÑÎ©îÏù∏: ${location.hostname}`);
      if (iosNoNoti){
        hints.push('iPhone Safari(Î∏åÎùºÏö∞Ï†Ä)ÏóêÏÑúÎäî ÏãúÏä§ÌÖú ÏïåÎ¶º ÎØ∏ÏßÄÏõê(Ìôà ÌôîÎ©¥ Ï∂îÍ∞Ä PWA ÌïÑÏöî)');
      }
      if (!iosNoNoti && isInIframe()){
        hints.push('ÏûÑÎ≤†Îìú(iframe) ÏÉÅÌÉú: ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ Ï∞®Îã® Í∞ÄÎä• ‚Üí "ÏÉà ÌÉ≠ÏúºÎ°ú Ïó¥Í∏∞" ÌïÑÏöî');
      }
      const base = (isOwner ? 'Î∞©Ïû• Í∂åÌïú: Î∞© Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Í∞ÄÎä•' : 'Î∞©Ïû•Îßå Î∞© Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Í∞ÄÎä•');
      menuHint.innerHTML = escapeHtml(base + (hints.length ? '\n' + hints.join('\n') : ''));
    }

    mEnableNoti.addEventListener('click', async () => {
      closeMenu();
      await enableNotificationsFromUserGesture();
    });

    mSound.addEventListener('click', async () => {
      closeMenu();
      await toggleSoundFromUserGesture();
    });

    // Ï∂îÍ∞Ä: ÎÇ¥ ÎßêÌíçÏÑ† Ìù∞ÏÉâ Î≤ÑÌäº
    mMyBubbleWhite.addEventListener('click', () => {
      closeMenu();
      toggleMyBubbleWhite();
    });

    // ---- Ï±ÑÌåÖ Î°úÏßÅ ----
    function setNick(nick){
      myNick = String(nick || '').trim();
      if (!myNick) return false;
      localStorage.setItem(LS_NICK, myNick);
      return true;
    }

    let onlineNicksCache = [];
    function setHeader(onlineNicks){
      if (Array.isArray(onlineNicks)) onlineNicksCache = onlineNicks;

      roomTitle.textContent = roomName || 'Ï±ÑÌåÖÎ∞©';
      const onlineText = (onlineNicksCache && onlineNicksCache.length) ? onlineNicksCache.join(', ') : 'ÏóÜÏùå';
      const unreadPill = unread > 0 ? `<span class="pill">ÏÉà Î©îÏãúÏßÄ ${unread}Í∞ú</span>` : '';

      roomSub.innerHTML = `
        <span class="pill">ÎÇ¥ ÎãâÎÑ§ÏûÑ: ${escapeHtml(myNick)}</span>
        <span class="pill">Ïò®ÎùºÏù∏: ${escapeHtml(onlineText)}</span>
        ${unreadPill}
      `;

      updateMenuStates();
    }

    function isNearBottom(){
      const gap = logEl.scrollHeight - (logEl.scrollTop + logEl.clientHeight);
      return gap < 140;
    }
    function scrollToBottom(force){
      if (!force && !isNearBottom()) return;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function showTypingBar(text){
      if (!text){
        typingBar.style.display = 'none';
        typingBar.textContent = '';
        typingBar.setAttribute('aria-hidden', 'true');
        return;
      }
      typingBar.style.display = 'flex';
      typingBar.textContent = text;
      typingBar.setAttribute('aria-hidden', 'false');
    }

    function renderMessage(m, opt){
      if (seen.has(m.messageId)) return;

      const wrap = document.createElement('div');
      wrap.className = 'msg';

      const row = document.createElement('div');
      row.className = 'row ' + (m.senderId === myUid ? 'me' : 'other');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = escapeHtml(m.text);

      row.appendChild(bubble);
      wrap.appendChild(row);

      const meta = document.createElement('div');
      meta.className = 'meta ' + (m.senderId === myUid ? 'me' : '');

      const who = document.createElement('span');
      who.textContent = m.senderNick || '';

      const time = document.createElement('span');
      time.textContent = fmt(m.ts || Date.now());

      meta.appendChild(who);
      meta.appendChild(time);

      if (m.senderId === myUid){
        if (opt && opt.pending){
          const b = document.createElement('span');
          b.className = 'badgePending';
          b.textContent = 'Ï†ÑÏÜ° Ï§ë';
          meta.appendChild(b);
        }
      }

      wrap.appendChild(meta);
      logEl.appendChild(wrap);

      seen.set(m.messageId, { seq: Number(m.seq || 0), metaEl: meta, senderId: m.senderId });
    }

    function updateBadges(){
      for (const [mid, obj] of seen.entries()){
        const meta = obj.metaEl;
        if (!meta) continue;

        Array.from(meta.querySelectorAll('.badgePending, .badgeFail')).forEach(n => n.remove());

        if (obj.senderId !== myUid) continue;

        if (pending.has(mid)) {
          const p = pending.get(mid);
          const age = Date.now() - p.createdAt;
          if (age > 12000) {
            const b = document.createElement('span');
            b.className = 'badgeFail';
            b.textContent = 'Ï†ÑÏÜ° Ïã§Ìå®(Ïû¨ÏãúÎèÑ)';
            b.addEventListener('click', () => retrySend(mid));
            meta.appendChild(b);
          } else {
            const b = document.createElement('span');
            b.className = 'badgePending';
            b.textContent = 'Ï†ÑÏÜ° Ï§ë';
            meta.appendChild(b);
          }
        }
      }
    }

    function updateReadBadges(){
      const otherUids = Object.keys(readsCache || {}).filter(uid => uid !== myUid);
      const totalOthers = otherUids.length;

      for (const [mid, obj] of seen.entries()){
        if (obj.senderId !== myUid) continue;
        const meta = obj.metaEl;
        if (!meta) continue;

        Array.from(meta.querySelectorAll('.readBadge')).forEach(n => n.remove());

        const seq = Number(obj.seq || 0);
        if (!seq) continue;
        if (pending.has(mid)) continue;

        let readers = 0;
        for (const uid of otherUids){
          const lastRead = Number((readsCache[uid] && readsCache[uid].lastReadSeq) || 0);
          if (lastRead >= seq) readers += 1;
        }

        const badge = document.createElement('span');
        badge.className = 'readBadge';

        if (totalOthers <= 1){
          badge.textContent = (readers >= 1) ? 'ÏùΩÏùå' : 'ÏïàÏùΩÏùå';
        } else {
          badge.textContent = `ÏùΩÏùå ${readers}/${totalOthers}`;
        }

        meta.appendChild(badge);
      }
    }

    function mergeServerMessage(m){
      if (!seen.has(m.messageId)){
        renderMessage(m, {pending:false});
      }
      if (pending.has(m.messageId)) pending.delete(m.messageId);

      const obj = seen.get(m.messageId);
      if (obj) obj.seq = Number(m.seq || obj.seq || 0);

      updateBadges();
      updateReadBadges();
    }

    async function refreshRooms(){
      roomList.innerHTML = '';
      try{
        const snap = await db.ref('rooms').orderByChild('updatedAt').limitToLast(50).once('value');
        const v = snap.val() || {};
        const items = Object.keys(v).map(id => ({ roomId:id, ...v[id] }));
        items.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));

        if (items.length === 0){
          const d = document.createElement('div');
          d.className = 'roomMeta';
          d.textContent = 'ÏÉùÏÑ±Îêú Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§. Î∞©ÏùÑ ÎßåÎì§Ïñ¥ Ï£ºÏÑ∏Ïöî.';
          roomList.appendChild(d);
          return;
        }

        items.forEach(r=>{
          const item = document.createElement('div');
          item.className = 'roomItem clickable';

          const left = document.createElement('div');
          left.className = 'roomLeft';

          const name = document.createElement('div');
          name.className = 'roomName';
          name.innerHTML = `<span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(r.roomName || 'Ï±ÑÌåÖÎ∞©')}</span>`;

          const meta = document.createElement('div');
          meta.className = 'roomMeta';
          meta.textContent = `Î∞©Ïû•: ${r.ownerNick || 'ÎØ∏ÌôïÏ†ï'} ¬∑ ÏµúÍ∑º ÌôúÎèô: ${r.updatedAt ? fmt(r.updatedAt) : 'ÏóÜÏùå'}`;

          left.appendChild(name);
          left.appendChild(meta);

          const right = document.createElement('div');
          right.className = 'roomRight';
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = 'ÏûÖÏû•';
          right.appendChild(chip);

          item.appendChild(left);
          item.appendChild(right);

          item.addEventListener('click', async () => {
            await joinRoomFlow(r.roomId);
          });

          roomList.appendChild(item);
        });
      }catch(e){
        const d = document.createElement('div');
        d.className = 'roomMeta';
        d.textContent = 'Î∞© Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§. (Í∂åÌïú/Í∑úÏπô ÌôïÏù∏ ÌïÑÏöî)';
        roomList.appendChild(d);
      }
    }

    btnRefresh.addEventListener('click', () => refreshRooms());

    btnCreate.addEventListener('click', async () => {
      const nick = homeNick.value.trim();
      if (!setNick(nick)) { alert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return; }

      const rn = homeRoomName.value.trim() || 'ÏÉà Ï±ÑÌåÖÎ∞©';
      if (!myUid) { alert('Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÎ•º ÌôïÏù∏ Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.'); return; }

      const newRoomId = uuid();
      const now = Date.now();

      const roomObj = {
        roomName: rn.slice(0, 60),
        ownerUid: myUid,
        ownerNick: myNick,
        createdAt: now,
        updatedAt: now,
        lastSeq: 0,
        lastMsgTs: 0
      };

      try{
        await db.ref('rooms/' + newRoomId).set(roomObj);
        history.pushState({}, '', NAV_URL + '?roomId=' + encodeURIComponent(newRoomId));
        await enterRoomLocal(newRoomId);
      }catch(e){
        alert('Î∞© ÏÉùÏÑ± Ïã§Ìå®: ' + (e && e.message ? e.message : ''));
      }
    });

    btnJoin.addEventListener('click', async () => {
      alert('Î∞© Î™©Î°ùÏóêÏÑú ÏûÖÏû•Ìï¥ Ï£ºÏÑ∏Ïöî.');
    });

    async function joinRoomFlow(rid){
      rid = String(rid||'').trim();
      if (!rid) return;
      if (!myNick){
        const nick = homeNick.value.trim();
        if (!setNick(nick)) { alert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return; }
      }
      if (!myUid){ alert('Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÎ•º ÌôïÏù∏ Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.'); return; }

      try{
        const snap = await db.ref('rooms/' + rid).once('value');
        if (!snap.exists()){ alert('Î∞©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'); return; }

        history.pushState({}, '', NAV_URL + '?roomId=' + encodeURIComponent(rid));
        await enterRoomLocal(rid);
      }catch(e){
        alert('ÏûÖÏû• Ïã§Ìå®: ' + (e && e.message ? e.message : ''));
      }
    }

    function stopPresence(){
      try{
        if (presenceTimer) clearInterval(presenceTimer);
        presenceTimer = null;
        if (presenceRef) presenceRef.onDisconnect().cancel();
        presenceRef = null;
      }catch(e){}
    }

    function startPresence(rid){
      stopPresence();

      presenceRef = db.ref('presence/' + rid + '/' + myUid);
      const obj = { nick: myNick, lastActive: SV.TIMESTAMP };
      presenceRef.onDisconnect().remove();
      presenceRef.set(obj);

      presenceTimer = setInterval(() => {
        presenceRef.update({ nick: myNick, lastActive: SV.TIMESTAMP });
      }, 25000);

      db.ref('presence/' + rid).orderByChild('lastActive').limitToLast(30).on('value', snap => {
        const v = snap.val() || {};
        const now = Date.now();
        const online = [];
        Object.keys(v).forEach(uid => {
          const p = v[uid] || {};
          const ts = Number(p.lastActive || 0);
          if (ts && (now - ts) <= 70000){
            if (p.nick) online.push(String(p.nick));
          }
        });
        const uniq = [];
        const s = new Set();
        for (const n of online){
          const t = String(n||'').trim();
          if (!t) continue;
          if (s.has(t)) continue;
          s.add(t);
          uniq.push(t);
        }
        setHeader(uniq.slice(0, 12));
      });
    }

    function stopTyping(){
      try{
        if (roomId && myUid){
          db.ref('typing/' + roomId + '/' + myUid).remove().catch(()=>{});
        }
        if (typingWatchRef){
          typingWatchRef.off();
          typingWatchRef = null;
        }
        if (typingKeepAliveTimer) clearInterval(typingKeepAliveTimer);
        typingKeepAliveTimer = null;

        typingOn = false;
        lastTypeAt = 0;

        showTypingBar('');
      }catch(e){}
    }

    function markTypingActivity(){
      lastTypeAt = Date.now();
    }

    function startTyping(rid){
      stopTyping();

      typingWatchRef = db.ref('typing/' + rid);
      typingWatchRef.on('value', snap => {
        const v = snap.val() || {};
        const now = Date.now();
        let best = null;

        Object.keys(v).forEach(uid => {
          if (uid === myUid) return;
          const t = v[uid] || {};
          const until = Number(t.until || 0);
          if (until > now){
            if (!best || until > best.until) best = { nick: String(t.nick||''), until };
          }
        });

        if (best && best.nick){
          showTypingBar(best.nick + ' ÎãòÏù¥ ÏûÖÎ†• Ï§ëÏûÖÎãàÎã§');
        } else {
          showTypingBar('');
        }
      });

      const myTypingRef = db.ref('typing/' + rid + '/' + myUid);
      myTypingRef.onDisconnect().remove();

      typingKeepAliveTimer = setInterval(() => {
        if (!roomId) return;

        const focused = (document.activeElement === inputEl);
        const hasText = inputEl.value.trim().length > 0;
        const activeRecently = (Date.now() - lastTypeAt) <= 4500;
        const should = focused && hasText && activeRecently;

        if (should){
          myTypingRef.set({ nick: myNick, until: Date.now() + 5500 });
          typingOn = true;
        } else if (typingOn){
          myTypingRef.remove();
          typingOn = false;
        }
      }, 2000);

      inputEl.addEventListener('input', markTypingActivity);
      inputEl.addEventListener('focus', markTypingActivity);
      inputEl.addEventListener('blur', () => {
        try{ myTypingRef.remove(); }catch(e){}
        typingOn = false;
      });

      window.addEventListener('beforeunload', () => {
        try{ myTypingRef.remove(); }catch(e){}
      });
    }

    // ===== ÏùΩÏùå(reads) =====
    function stopReads(){
      try{
        if (readsWatchRef){
          readsWatchRef.off();
          readsWatchRef = null;
        }
        if (readsMarkTimer) clearInterval(readsMarkTimer);
        readsMarkTimer = null;

        if (readsScrollTimer) clearTimeout(readsScrollTimer);
        readsScrollTimer = null;

        readsCache = {};
      }catch(e){}
    }

    function canMarkRead(){
      if (!roomId) return false;
      if (document.hidden) return false;
      if (!document.hasFocus()) return false;
      if (logEl.style.display === 'none') return false;
      if (!isNearBottom()) return false;
      return true;
    }

    function markReadNow(){
      if (!canMarkRead()) return;
      const seq = Number(afterSeq || 0);
      if (!seq) return;

      const ref = db.ref('reads/' + roomId + '/' + myUid);
      ref.set({
        nick: myNick,
        lastReadSeq: seq,
        ts: SV.TIMESTAMP
      }).catch(()=>{});
    }

    function startReads(rid){
      stopReads();

      readsWatchRef = db.ref('reads/' + rid);
      readsWatchRef.on('value', snap => {
        readsCache = snap.val() || {};
        updateReadBadges();
      });

      readsMarkTimer = setInterval(() => {
        markReadNow();
      }, 2000);

      logEl.addEventListener('scroll', () => {
        if (readsScrollTimer) clearTimeout(readsScrollTimer);
        readsScrollTimer = setTimeout(() => markReadNow(), 120);
      });

      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) markReadNow();
      });
      window.addEventListener('focus', () => markReadNow());
    }

    function stopMessages(){
      try{
        if (msgUnsub){
          msgUnsub.off();
          msgUnsub = null;
        }
      }catch(e){}
    }

    function subscribeMessages(rid, startSeq){
      stopMessages();

      logEl.innerHTML = '';
      seen.clear();
      pending.clear();
      afterSeq = Number(startSeq || 0);

      const ref = db.ref('messages/' + rid).orderByChild('seq').startAt(afterSeq + 1);
      msgUnsub = ref;

      ref.on('child_added', snap => {
        const m = snap.val();
        if (!m) return;

        const msg = {
          roomId: rid,
          messageId: String(m.messageId || snap.key || ''),
          senderId: String(m.senderId || ''),
          senderNick: String(m.senderNick || ''),
          text: String(m.text || ''),
          ts: Number(m.ts || 0),
          seq: Number(m.seq || 0)
        };

        afterSeq = Math.max(afterSeq, msg.seq || 0);
        mergeServerMessage(msg);

if (msg.senderId !== myUid) {
  if (document.hidden || !document.hasFocus()) {
    bumpUnread();
  } else {
    if (shouldNotifyNow()) {
      bumpUnread();
      playBeep();
    } else {
      if (isNearBottom()) clearUnread();
    }
  }
}

        scrollToBottom(false);
        markReadNow();
      });
    }

    async function loadRoomInfo(rid){
      const snap = await db.ref('rooms/' + rid).once('value');
      if (!snap.exists()) return null;
      const r = snap.val() || {};
      return {
        roomId: rid,
        roomName: String(r.roomName || ''),
        ownerUid: String(r.ownerUid || ''),
        ownerNick: String(r.ownerNick || ''),
        lastSeq: Number(r.lastSeq || 0),
        updatedAt: Number(r.updatedAt || 0)
      };
    }

    async function enterRoomLocal(rid){
      stopMessages();
      stopPresence();
      stopTyping();
      stopReads();

      const info = await loadRoomInfo(rid);
      if (!info){
        showHome();
        return;
      }

      roomId = rid;
db.ref('roomMembers/' + roomId + '/' + myUid).set({
  nick: myNick,
  joinedAt: SV.TIMESTAMP
}).catch(()=>{});
      roomName = info.roomName;
      ownerUid = info.ownerUid;
      ownerNick = info.ownerNick;
      isOwner = (ownerUid && ownerUid === myUid);

      clearUnread();

      showChat();
      setHeader([]);
      startPresence(roomId);
      startTyping(roomId);
      startReads(roomId);

      subscribeMessages(roomId, 0);
    }

    function showChat(){
      home.style.display = 'none';
      header.style.display = 'block';
      logEl.style.display = 'block';
      composer.style.display = 'flex';
      inputEl.focus();
    }

    function showHome(){
      stopMessages();
      stopPresence();
      stopTyping();
      stopReads();
      clearUnread();

      header.style.display = 'none';
      logEl.style.display = 'none';
      composer.style.display = 'none';
      showTypingBar('');
      home.style.display = 'block';
      refreshRooms();
    }

    mLeave.addEventListener('click', () => {
      closeMenu();
      history.pushState({}, '', NAV_URL);
      roomId = '';
      showHome();
    });

    mNick.addEventListener('click', async () => {
      closeMenu();
      const next = prompt('ÏÉà ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.', myNick || '');
      if (!next) return;
      if (!setNick(next)) return;

      homeNick.value = myNick;
      if (roomId){
        try{
          db.ref('presence/' + roomId + '/' + myUid).update({ nick: myNick, lastActive: SV.TIMESTAMP });
          db.ref('typing/' + roomId + '/' + myUid).update({ nick: myNick }).catch(()=>{});
          db.ref('reads/' + roomId + '/' + myUid).update({ nick: myNick }).catch(()=>{});
        }catch(e){}
      }
      setHeader([]);
    });

    mRoomName.addEventListener('click', async () => {
      closeMenu();
      if (!roomId) return;
      if (!isOwner){
        alert('Î∞©Ïû•Îßå Î∞© Ïù¥Î¶ÑÏùÑ Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§.');
        return;
      }
      const next = prompt('ÏÉà Î∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.', roomName || '');
      if (!next) return;

      const newName = String(next).trim().slice(0, 60);
      if (!newName) return;

      try{
        await db.ref('rooms/' + roomId).update({ roomName: newName, updatedAt: SV.TIMESTAMP });
        roomName = newName;
        setHeader([]);
        alert('Î∞© Ïù¥Î¶ÑÏùÑ Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§.');
      }catch(e){
        alert('Î≥ÄÍ≤Ω Ïã§Ìå®: ' + (e && e.message ? e.message : ''));
      }
    });

    function onInput(){
      sendBtn.disabled = !inputEl.value.trim();
      if (roomId) markTypingActivity();
    }
    inputEl.addEventListener('input', onInput);

    function msgId(){
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return 'm' + Date.now() + '_' + Math.random().toString(16).slice(2);
    }

    async function sendToFirebase(mid, text){
  if (!roomId) return;

  const roomRef = db.ref('rooms/' + roomId + '/lastSeq');
  try{
    const tx = await roomRef.transaction(cur => (Number(cur || 0) + 1));
    const seq = Number((tx && tx.snapshot && tx.snapshot.val()) || 0);

    const msg = {
      messageId: mid,
      senderId: myUid,
      senderNick: myNick,
      text: String(text || '').slice(0, 4000),
      ts: SV.TIMESTAMP,
      seq: seq
    };

    await db.ref('messages/' + roomId).push(msg);
    await db.ref('rooms/' + roomId).update({ updatedAt: SV.TIMESTAMP, lastMsgTs: SV.TIMESTAMP });

    // ‚úÖ Ï∂îÍ∞Ä: ÏÉÅÎåÄ(Î∞© Î©§Î≤Ñ)ÏóêÍ≤å Ìë∏Ïãú Î≥¥ÎÇ¥Í∏∞
    try{
      const membersSnap = await db.ref('roomMembers/' + roomId).once('value');
      const members = membersSnap.val() || {};
      const otherUids = Object.keys(members).filter(uid => uid !== myUid);

      if (otherUids.length){
        const subsSnaps = await Promise.all(
          otherUids.map(uid => db.ref('pushSubs/' + uid).once('value'))
        );

        let subIds = [];
        subsSnaps.forEach(s => {
          const v = s.val() || {};
          subIds.push(...Object.keys(v));
        });

        subIds = Array.from(new Set(subIds));

        if (subIds.length){
          const title = roomName || 'Chat';
          const body = String(text || '').slice(0, 120);
          pushToSubscriptions(subIds, title, body, roomId);
        }
      }
    }catch(e){}
  }catch(e){
    updateBadges();
  }
}

    function retrySend(mid){
      const p = pending.get(mid);
      if (!p) return;
      p.createdAt = Date.now();
      pending.set(mid, p);
      updateBadges();
      sendToFirebase(mid, p.text);
    }

    function send(){
      const text = inputEl.value;
      if (!text.trim()) return;
      if (!roomId) return;

      const mid = msgId();

      const local = {
        roomId,
        messageId: mid,
        senderId: myUid,
        senderNick: myNick,
        text: text,
        ts: Date.now(),
        seq: 0
      };

      renderMessage(local, {pending:true});
      scrollToBottom(true);

      pending.set(mid, { text, createdAt: Date.now() });
      updateBadges();

      inputEl.value = '';
      onInput();

      try{ db.ref('typing/' + roomId + '/' + myUid).remove(); }catch(e){}
      typingOn = false;

      sendToFirebase(mid, text);
    }

    function safeFocusInput(){
      try{ inputEl.focus({ preventScroll:true }); }
      catch(e){ try{ inputEl.focus(); }catch(e2){} }
    }

    sendBtn.addEventListener('pointerdown', async (e) => {
      e.preventDefault();
      if (soundEnabled) { await unlockAudioHard(); }
      send();
      safeFocusInput();
    });

    inputEl.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        if (soundEnabled) { await unlockAudioHard(); }
        send();
        safeFocusInput();
      }
    });

    async function init(){
      if (myNick) homeNick.value = myNick;

      try{
        const cred = await firebase.auth().signInAnonymously();
        myUid = (cred && cred.user && cred.user.uid) ? cred.user.uid : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : '');schedulePushSync();
      }catch(e){
        alert('Firebase Ïù∏Ï¶ù Ïã§Ìå®: ' + (e && e.message ? e.message : ''));
        return;
      }

      // Ï¥àÍ∏∞ Î©îÎâ¥ ÏÉÅÌÉú/ÌÖåÎßà Î∞òÏòÅ
      applyMyBubbleTheme();
      updateMenuStates();

      if (INIT_ROOM_ID){
        if (!myNick){
          showHome();
          return;
        }
        const rid = String(INIT_ROOM_ID||'').trim();
        if (!rid){
          showHome();
          return;
        }
        await enterRoomLocal(rid);
        return;
      }

      showHome();
    }

    init();
  </script>
</body>
</html>





